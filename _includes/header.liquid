<header>
  <!-- Nav Bar -->
  <nav id="navbar" class="navbar navbar-light navbar-expand-sm {% if site.navbar_fixed %}fixed-top{% else %}sticky-top{% endif %}" role="navigation">
    <div class="container">
      {% if page.permalink != '/' %}
        <a class="navbar-brand title font-weight-lighter" href="{{ site.baseurl }}/">
          {% if site.title == 'blank' %}
            {% if site.first_name %}
              <span class="font-weight-bold">
                {{- site.first_name -}}
              </span>
            {% endif %}
            {% if site.middle_name %}
              {{- site.middle_name -}}
            {% endif %}
            {% if site.last_name %}
              {{- site.last_name -}}
            {% endif %}
          {% else %}
            {{- site.title -}}
          {% endif %}
        </a>
      {% elsif site.enable_navbar_social %}
        <!-- Social Icons -->
        <div class="navbar-brand social">{% social_links %}</div>
      {% endif %}
      <!-- Navbar Toggle -->
      <button
        class="navbar-toggler collapsed ml-auto"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>

      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          {% for page in site.pages %}
            {% if page.permalink == '/' %} {% assign about_title = page.title %} {% endif %}
          {% endfor %}

          <!-- About -->
          <li class="nav-item {% if page.permalink == '/' %}active{% endif %}">
            <a class="nav-link" href="{{ '/' | relative_url }}">
              {{- about_title }}
              {% if page.permalink == '/' %}
                <span class="sr-only">(current)</span>
              {% endif %}
            </a>
          </li>

          <!-- Other pages -->
          {% assign sorted_pages = site.pages | sort: 'nav_order' %}
          {% for p in sorted_pages %}
            {% if p.nav and p.autogen == null %}
              {% if p.dropdown %}
                {% assign has_active_child = false %}
                {% for child in p.children %}
                  {% if page.title == child.title %}
                    {% assign has_active_child = true %}
                  {% endif %}
                {% endfor %}
                <li class="nav-item dropdown {% if page.title == p.title or has_active_child %}active{% endif %}">
                  <a
                    class="nav-link dropdown-toggle"
                    href="#"
                    id="navbarDropdown"
                    role="button"
                    data-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false"
                  >
                    {{- p.nav_title | default: p.title }}
                    {% if page.title == p.title or has_active_child %}
                      <span class="sr-only">(current)</span>
                    {% endif %}
                  </a>
                  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                    {% for child in p.children %}
                      {% if child.title == 'divider' %}
                        <div class="dropdown-divider"></div>
                      {% else %}
                        <a
                          class="dropdown-item {% if page.title == child.title %}active{% endif %}"
                          href="{% if child.permalink contains '://' %}{{ child.permalink }}{% else %}{{ child.permalink | relative_url }}{% endif %}"
                        >
                          {{- child.title -}}
                        </a>
                      {% endif %}
                    {% endfor %}
                  </div>
                </li>
              {% else %}
                {% assign parent_link = p.permalink | remove: 'index.html' %}
                <li class="nav-item {% if page.url contains parent_link %}active{% endif %}">
                  {%- if p.permalink contains '://' -%}
                    {%- assign url = p.permalink -%}
                  {%- elsif p.permalink contains '/blog/' -%}
                    {%- assign url = '/blog/' -%}
                  {%- else -%}
                    {%- assign url = p.url -%}
                  {%- endif %}
                  <a class="nav-link" href="{{ url | relative_url }}">
                    {{- p.nav_title | default: p.title }}
                    {% if page.url contains p.url %}
                      <span class="sr-only">(current)</span>
                    {% endif %}
                  </a>
                </li>
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if site.search_enabled %}
            <!-- Search -->
            <li class="nav-item">
              <button
                id="search-toggle"
                type="button"
                title="Search"
                onclick="return window.__alfolioOpenSearchFromHeader ? window.__alfolioOpenSearchFromHeader(event) : false;"
              >
                <span class="nav-link"><i class="fa-solid fa-magnifying-glass"></i><span class="sr-only">Search (Ctrl+K)</span></span>
              </button>
            </li>
            <script>
              (function () {
                if (window.__alfolioHeaderSearchInitialized) return;
                window.__alfolioHeaderSearchInitialized = true;

                function escapeHtml(text) {
                  return String(text || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
                }

                function getNinjaItems() {
                  var ninja = document.querySelector('ninja-keys');
                  if (!ninja || !Array.isArray(ninja.data)) return [];
                  return ninja.data.filter(function (item) {
                    return item && typeof item.title === 'string' && typeof item.handler === 'function';
                  });
                }

                function getNavItems() {
                  var links = document.querySelectorAll('.navbar-nav a.nav-link[href]');
                  var items = [];

                  links.forEach(function (link, index) {
                    var title = (link.textContent || '').trim();
                    var href = link.getAttribute('href');
                    if (!title || !href || href === '#') return;

                    items.push({
                      id: 'nav-fallback-' + index,
                      title: title,
                      section: 'Navigation',
                      handler: function () {
                        window.location.href = href;
                      }
                    });
                  });

                  return items;
                }

                function getSearchItems() {
                  var ninjaItems = getNinjaItems();
                  return ninjaItems.length ? ninjaItems : getNavItems();
                }

                function ensureFallbackModal() {
                  var existing = document.getElementById('alfolio-search-fallback');
                  if (existing) return existing;

                  var overlay = document.createElement('div');
                  overlay.id = 'alfolio-search-fallback';
                  overlay.style.cssText = [
                    'position:fixed',
                    'inset:0',
                    'display:none',
                    'align-items:flex-start',
                    'justify-content:center',
                    'padding:8vh 1rem 1rem',
                    'background:rgba(0,0,0,.35)',
                    'z-index:2100'
                  ].join(';');

                  overlay.innerHTML =
                    '<div style="width:min(760px,100%); background:var(--global-card-bg-color,#fff); color:var(--global-text-color,#111); border:1px solid var(--global-divider-color,#ddd); border-radius:12px; box-shadow:0 12px 36px rgba(0,0,0,.22); overflow:hidden;">' +
                    '  <div style="padding:.75rem; border-bottom:1px solid var(--global-divider-color,#ddd);">' +
                    '    <input id="alfolio-search-input" type="text" placeholder="Type to search..." style="width:100%; border:0; outline:0; background:transparent; color:inherit; font-size:1rem;" />' +
                    '  </div>' +
                    '  <div id="alfolio-search-results" style="max-height:55vh; overflow:auto; padding:.35rem;"></div>' +
                    '</div>';

                  overlay.addEventListener('click', function (e) {
                    if (e.target === overlay) closeFallbackSearch();
                  });

                  document.body.appendChild(overlay);
                  return overlay;
                }

                function renderFallbackResults(query) {
                  var resultsContainer = document.getElementById('alfolio-search-results');
                  if (!resultsContainer) return;

                  var q = String(query || '').trim().toLowerCase();
                  var results = getSearchItems();

                  if (q) {
                    results = results.filter(function (item) {
                      var haystack = [item.title, item.description || '', item.section || ''].join(' ').toLowerCase();
                      return haystack.indexOf(q) !== -1;
                    });
                  }

                  results = results.slice(0, 15);

                  if (!results.length) {
                    resultsContainer.innerHTML =
                      '<div style="padding:.8rem; color:var(--global-text-color-light,#666);">No results found.</div>';
                    return;
                  }

                  resultsContainer.innerHTML = '';
                  results.forEach(function (item, idx) {
                    var button = document.createElement('button');
                    button.type = 'button';
                    button.style.cssText = [
                      'width:100%',
                      'text-align:left',
                      'border:0',
                      'background:transparent',
                      'color:inherit',
                      'padding:.55rem .6rem',
                      'border-radius:8px',
                      'cursor:pointer'
                    ].join(';');

                    button.innerHTML =
                      '<div style="font-weight:600;">' + escapeHtml(item.title) + '</div>' +
                      (item.description
                        ? '<div style="font-size:.86rem; opacity:.85; margin-top:.1rem;">' + escapeHtml(item.description) + '</div>'
                        : '') +
                      (item.section
                        ? '<div style="font-size:.75rem; opacity:.7; margin-top:.12rem;">' + escapeHtml(item.section) + '</div>'
                        : '');

                    button.addEventListener('mouseenter', function () {
                      button.style.background = 'var(--global-bg-color, rgba(0,0,0,.03))';
                    });
                    button.addEventListener('mouseleave', function () {
                      button.style.background = 'transparent';
                    });
                    button.addEventListener('click', function () {
                      closeFallbackSearch();
                      item.handler();
                    });

                    if (idx === 0) button.id = 'alfolio-search-first-result';
                    resultsContainer.appendChild(button);
                  });
                }

                function openFallbackSearch() {
                  var overlay = ensureFallbackModal();
                  overlay.style.display = 'flex';

                  var input = document.getElementById('alfolio-search-input');
                  if (!input) return;

                  input.value = '';
                  renderFallbackResults('');

                  input.oninput = function () {
                    renderFallbackResults(input.value);
                  };
                  input.onkeydown = function (e) {
                    if (e.key === 'Escape') {
                      e.preventDefault();
                      closeFallbackSearch();
                      return;
                    }
                    if (e.key === 'Enter') {
                      var first = document.getElementById('alfolio-search-first-result');
                      if (first) {
                        e.preventDefault();
                        first.click();
                      }
                    }
                  };

                  setTimeout(function () {
                    input.focus();
                  }, 0);
                }

                function closeFallbackSearch() {
                  var overlay = document.getElementById('alfolio-search-fallback');
                  if (!overlay) return;
                  overlay.style.display = 'none';
                }

                function openFromHeader(event) {
                  if (event && typeof event.preventDefault === 'function') event.preventDefault();

                  try {
                    if (typeof window.openSearchModal === 'function' && window.openSearchModal !== openFromHeader) {
                      window.openSearchModal();
                      return false;
                    }
                  } catch (e) {
                    // Fall back to inline modal if external search scripts fail.
                  }

                  var ninja = document.querySelector('ninja-keys');
                  if (ninja && typeof ninja.open === 'function') {
                    ninja.open();
                    return false;
                  }

                  openFallbackSearch();
                  return false;
                }

                window.__alfolioOpenSearchFromHeader = openFromHeader;
                if (typeof window.openSearchModal !== 'function') {
                  window.openSearchModal = openFromHeader;
                }

                if (!window.__alfolioSearchShortcutInitialized) {
                  window.__alfolioSearchShortcutInitialized = true;
                  document.addEventListener('keydown', function (event) {
                    if (event.defaultPrevented) return;
                    if ((event.target && event.target.isContentEditable) || /^(INPUT|TEXTAREA|SELECT)$/.test((event.target || {}).tagName || '')) {
                      return;
                    }
                    if ((event.ctrlKey || event.metaKey) && !event.altKey && String(event.key || '').toLowerCase() === 'k') {
                      event.preventDefault();
                      openFromHeader();
                    }
                  });
                }
              })();
            </script>
          {% endif %}
          {% if site.enable_darkmode %}
            <!-- Toogle theme mode -->
            <li class="toggle-container">
              <button
                id="light-toggle"
                type="button"
                title="Change theme"
                onclick="return window.__alfolioCycleThemeFromButton ? window.__alfolioCycleThemeFromButton(event) : true;"
              >
                <i class="fa-half-sun-moon" id="light-toggle-system"></i>
                <i class="fa-solid fa-moon" id="light-toggle-dark"></i>
                <i class="fa-solid fa-sun" id="light-toggle-light"></i>
              </button>
            </li>
            <script>
              (function () {
                if (window.__alfolioCycleThemeFromButton) return;

                function prefersDark() {
                  return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                }

                function getThemeSetting() {
                  try {
                    return localStorage.getItem('theme') || 'system';
                  } catch (e) {
                    return 'system';
                  }
                }

                function applyThemeSetting(setting) {
                  var next = setting || getThemeSetting();
                  var root = document.documentElement;

                  if (next === 'system') {
                    root.removeAttribute('data-theme-setting');
                  } else {
                    root.setAttribute('data-theme-setting', next);
                  }

                  if (next === 'dark' || (next === 'system' && prefersDark())) {
                    root.setAttribute('data-theme', 'dark');
                  } else {
                    root.removeAttribute('data-theme');
                  }
                }

                window.__alfolioCycleThemeFromButton = function (event) {
                  if (event) {
                    if (typeof event.preventDefault === 'function') event.preventDefault();
                    if (typeof event.stopImmediatePropagation === 'function') event.stopImmediatePropagation();
                  }

                  var current = getThemeSetting();
                  var next = current === 'system' ? 'dark' : current === 'dark' ? 'light' : 'system';

                  try {
                    localStorage.setItem('theme', next);
                  } catch (e) {
                    // Ignore storage errors (private mode / disabled storage)
                  }

                  applyThemeSetting(next);
                  return false;
                };
              })();
            </script>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>
  {% if site.enable_progressbar %}
    <!-- Scrolling Progress Bar -->
    <progress id="progress" value="0">
      <div class="progress-container">
        <span class="progress-bar"></span>
      </div>
    </progress>
  {% endif %}
</header>
